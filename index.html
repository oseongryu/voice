<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>화면 제어 - 음성 텍스트 변환</title>
  <!-- AG Grid CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-grid.css" />
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <!-- Toast Notification Settings -->
  <script src="static/js/toast-settings.js"></script>
  <link rel="icon" href="static/favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="static/css/screenshot.css" />
  <link rel="stylesheet" href="static/css/navbar.css" />

  <!-- Universal Modal Loader -->
  <script src="static/js/components/modal-loader.js"></script>
</head>

<body>
  <!-- Bootstrap Navbar -->
  <nav id="topNavbar" class="navbar navbar-expand navbar-light bg-light">
    <div class="container-fluid">
      <!-- Floating Header Collapse Button -->
      <button class="btn btn-sm btn-outline-secondary me-2 floating-collapse-btn" onclick="toggleFloatingHeader()"
        title="메뉴 숨기기" style="display: none;">
        <i class="bi bi-chevron-right"></i>
      </button>

      <!-- Brand & Mode Selector -->
      <a class="navbar-brand me-3" href="#" data-i18n="nav.brand">제어</a>

      <!-- Navbar Content -->
      <div class="navbar-collapse" id="mainNavbar">
        <!-- Screenshot Mode Controls -->
        <ul id="mainNavButtons" class="navbar-nav mb-2 mb-sm-0 align-items-center flex-row">
          <!-- Main Action: Screenshot (Visible only in Screenshot Mode) -->
          <li class="nav-item me-2" id="screenshotActionItem">
            <button id="takeScreenshotBtn" class="btn btn-primary btn-sm" onclick="takeNewScreenshot()"
              title="새 스크린샷 캡처">
              <i class="bi bi-camera-fill"></i> <span data-i18n="nav.screenshot">화면</span>
            </button>
          </li>

          <!-- Text Input Button -->
          <li class="nav-item me-2">
            <button class="btn btn-outline-secondary btn-sm" onclick="showTypeTextModal()" title="텍스트 입력">
              <i class="bi bi-keyboard"></i> <span data-i18n="nav.text">Text</span>
            </button>
          </li>



          <!-- Mouse Mode Button -->
          <li class="nav-item me-2">
            <button id="mouseModeBtn" class="btn btn-outline-secondary btn-sm" onclick="toggleMouseMode()"
              title="마우스 이동 모드">
              <i class="bi bi-cursor-fill"></i> <span data-i18n="nav.mouse">마우스</span>
            </button>
          </li>

          <!-- Voice Button -->
          <li class="nav-item me-2">
            <button id="voiceBtn" class="btn btn-outline-secondary btn-sm" onclick="toggleVoiceActivation()"
              title="음성 인식">
              <i class="bi bi-mic-fill"></i> <span data-i18n="nav.voice">음성</span>
            </button>
          </li>

          <!-- WebSocket Toggle Button (Live Connection) -->
          <li class="nav-item me-2">
            <button id="wsToggleBtn" class="btn btn-outline-secondary btn-sm" onclick="toggleWebSocketConnection()"
              title="라이브">
              <i class="bi bi-plug"></i>라이브
            </button>
          </li>

          <!-- Tools Dropdown -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="toolsDropdown" role="button" data-bs-toggle="dropdown"
              aria-expanded="false">
              <i class="bi bi-tools"></i> <span data-i18n="nav.tools">도구</span>
            </a>
            <ul class="dropdown-menu" aria-labelledby="toolsDropdown">
              <li>
                <button class="dropdown-item" onclick="showServerConfigModal()">
                  <i class="bi bi-hdd-network"></i> <span>API 서버 연결</span>
                </button>
              </li>
              <li>
                <button class="dropdown-item" onclick="showSettingModal()">
                  <i class="bi bi-gear"></i> <span data-i18n="nav.tools.debug">설정</span>
                </button>
              </li>
              <li>
                <button class="dropdown-item" onclick="showVoiceSettingsModal()">
                  <i class="bi bi-mic-fill"></i> <span data-i18n="nav.tools.voice_settings">음성 설정</span>
                </button>
              </li>

              <li>
                <button class="dropdown-item" onclick="showClickRecorderModal()">
                  <i class="bi bi-record-circle"></i><span data-i18n="nav.tools.macro">매크로 기록</span>
                </button>
              </li>
              <li>
                <button class="dropdown-item" onclick="showVoiceHistoryModal()">
                  <i class="bi bi-journal-text"></i><span data-i18n="nav.tools.history">음성 히스토리</span>
                </button>
              </li>
            </ul>
          </li>
          <!-- User Account Dropdown -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown"
              aria-expanded="false">
              <i class="bi bi-person-circle"></i> <span id="currentUsername">사용자</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
              <li>
                <h6 class="dropdown-header">
                  <i class="bi bi-person-badge"></i> 계정
                </h6>
              </li>
              <li>
                <hr class="dropdown-divider">
              </li>
              <li>
                <button class="dropdown-item" onclick="show2FASettingsModal()">
                  <i class="bi bi-shield-lock"></i> <span>2단계 인증</span>
                </button>
              </li>
              <li>
                <hr class="dropdown-divider">
              </li>
              <li>
                <button class="dropdown-item text-danger" onclick="handleLogout()">
                  <i class="bi bi-box-arrow-right"></i> <span>로그아웃</span>
                </button>
              </li>
            </ul>
          </li>

          <!-- Coordinates -->
          <li class="nav-item me-3">
            <div id="coordinates"
              class="badge bg-dark text-wrap font-monospace d-flex justify-content-center align-items-center"
              style="font-size: 0.85rem; width: 140px;">(0, 0)</div>
          </li>

          <!-- Zoom Controls -->
          <li class="nav-item">
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-secondary" onclick="zoomOut()" title="축소"><i
                  class="bi bi-dash"></i></button>
              <span class="btn btn-outline-secondary disabled text-dark border-start-0 border-end-0" id="zoomLevelLabel"
                style="opacity: 1; background: #fff; min-width: 50px;">100%</span>
              <button class="btn btn-outline-secondary" onclick="zoomIn()" title="확대"><i
                  class="bi bi-plus"></i></button>
              <button class="btn btn-outline-secondary" onclick="resetZoom()" title="초기화"><i
                  class="bi bi-arrow-counterclockwise"></i></button>
              <button class="btn btn-outline-secondary" onclick="toggleFullScreen()" title="전체화면"><i
                  class="bi bi-arrows-fullscreen"></i></button>
              <button class="btn btn-outline-secondary" onclick="fitToScreen()" title="재조정"><i
                  class="bi bi-arrow-repeat"></i></button>
            </div>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Floating Header Controls -->
  <button id="floatingHeaderBtn" class="header-floating-btn" onclick="toggleFloatingHeader()" title="메뉴 열기">
    <i class="bi bi-list"></i>
  </button>

  <script>
    /* Floating Header Logic */
    function toggleFloatingHeader() {
      const body = document.body;
      const navbar = document.getElementById('topNavbar');

      // Toggle visibility classes
      const isVisible = body.classList.contains('header-visible');

      if (isVisible) {
        body.classList.remove('header-visible');
        navbar.classList.remove('show');
      } else {
        body.classList.add('header-visible');
        navbar.classList.add('show');
      }
    }
  </script>

  <div class="container">
    <div id="screenshotContainer" class="screenshot-container">
      <div class="screenshot-content">
        <img id="screenshotImage" class="screenshot-image" alt="서버 화면" />
      </div>

    </div>

    <!-- Voice Command Floating Overlay -->
    <div id="voiceCommandOverlay" class="voice-command-overlay">
      <div class="voice-command-header">
        <i class="bi bi-mic-fill"></i> <span data-i18n="voice.listening">듣고 있습니다...</span>
      </div>
      <div id="voiceCommandStatus" class="voice-command-status" data-i18n="voice.status.ready">명령을 말씀하세요</div>
    </div>

    <!-- bottom toast area used for general messages -->
    <div id="bottomToast" class="bottom-toast" aria-live="polite"></div>

    <!-- Modal Components -->
    <modal-server-config></modal-server-config>
    <modal-login></modal-login>
    <modal-setting></modal-setting>
    <modal-click-recorder></modal-click-recorder>
    <modal-text-input></modal-text-input>
    <modal-voice-history></modal-voice-history>
    <modal-voice-settings></modal-voice-settings>
  </div>



  <!-- Modal Interaction Scripts -->
  <script src="static/js/server-config-interactions.js"></script>
  <script src="static/js/login-modal.js"></script>
  <script src="static/js/voice-settings-interactions.js"></script>

  <!-- Socket.IO 클라이언트 라이브러리 -->
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>

  <!-- Server Configuration Script -->
  <script src="static/js/config.js"></script>

  <!-- External JavaScript modules -->
  <script src="static/js/auth-utils.js"></script>
  <script src="static/js/coordinate-utils.js"></script>
  <script src="static/js/text-input-utils.js"></script>
  <script src="static/js/screenshot-core.js"></script>
  <script src="static/js/screenshot-modals.js"></script>
  <script src="static/js/screenshot-interactions.js"></script>
  <script src="static/js/click-recorder.js"></script>
  <script>
    try {
      // console.log('bootstrap: click-recorder.js loaded, initGlobalRecorderButtons=', typeof initGlobalRecorderButtons);
      if (typeof initGlobalRecorderButtons === 'function') initGlobalRecorderButtons();
    } catch (e) { console.log('bootstrap error', e); }
  </script>
  <script src="static/js/screenshot-utils.js"></script>
  <script src="static/js/screenshot-voice.js"></script>
  <script src="static/js/mouse-mode.js"></script>

  <!-- 모드 관리자 -->
  <script src="static/js/mode-manager.js"></script>

  <!-- WebSocket 화면인식 모듈 -->
  <script src="static/js/websocket-screenshot.js"></script>
  <script src="static/js/websocket-utils.js"></script>

  <!-- JavaScript 라이브러리들 -->
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/ag-grid-community.min.js"></script>
  <script src="static/js/speech-to-text.js"></script>
  <script src="static/js/history-api.js"></script>
  <script src="static/js/voice-activation.js"></script>
  <script src="static/js/voice-activation-integration.js"></script>
  <script src="static/js/i18n.js"></script>

  <!-- Bootstrap Bundle with Popper (Required for Dropdowns) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"></script>



  <!-- 인증 처리 제거 (GitHub Pages에서는 인증 불필요) -->
  <script>
    // 페이지 로드 시 작업 (인증 체크 제거)
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('Voice Coding Client - GitHub Pages Version');
      console.log('Server URL:', AppConfig.getServerUrl());
    });
  </script>

  <script src="static/js/2fa-settings.js"></script>
  <script src="static/js/user-account.js"></script>

  <!-- 인증 체크 스크립트 -->
  <script>
    // 페이지 로드 시 로그인 확인 (더 확실하게)
    document.addEventListener('DOMContentLoaded', function () {
      console.log('인증 체크 시작...');

      // showLoginModal 함수가 로드될 때까지 대기
      const checkAuthAndShowModal = () => {
        if (typeof AuthUtils === 'undefined' || typeof showLoginModal === 'undefined') {
          console.log('AuthUtils 또는 showLoginModal 로딩 대기 중...');
          setTimeout(checkAuthAndShowModal, 50);
          return;
        }

        const token = AuthUtils.getStoredToken();

        if (!token) {
          console.log('토큰이 없음 - 로그인 모달 표시');
          // 약간의 지연 후 모달 표시 (DOM 완전히 준비되도록)
          setTimeout(() => {
            showLoginModal();
          }, 100);
          return;
        }

        // 토큰이 만료되었는지 확인
        if (AuthUtils.isTokenExpired(token)) {
          console.log('토큰 만료됨 - 로그인 모달 표시');
          AuthUtils.clearStoredToken();
          setTimeout(() => {
            showLoginModal();
          }, 100);
          return;
        }

        console.log('유효한 토큰 존재 - 인증 통과');
      };

      // 인증 체크 시작
      checkAuthAndShowModal();
    });
  </script>

</body>

</html>